<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    #map { height: 100vh; width: 100vw; }
  </style>
</head>
<body>

  <div id="editModeToggle">
    <button id="editModeToggleBtn" style="font-weight:bold;padding:6px 18px;background:#1976d2;color:white;border:none;border-radius:6px;cursor:pointer;">
      Bewerk modus
    </button>
    <button id="saveMarkersBtn" style="margin-left:16px;">Opslaan</button>
    <span id="saveStatus" style="margin-left:8px;color:green;"></span>
  </div>
  <div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
var map = L.map('map', {
  minZoom: 16,
  maxZoom: 22
}).setView([51.898819375615844, 5.7732504428013165], 18);

var terrainMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
  subdomains: 'abcd',
  minZoom: 16,
  maxZoom: 22
});
terrainMap.addTo(map);
var esri_WorldImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
});
esri_WorldImagery.addTo(map);


// --- Edit Mode Logic ---
var editMode = localStorage.getItem('editMode') === 'true';
var editModeToggleBtn = document.getElementById('editModeToggleBtn');
var saveMarkersBtn = document.getElementById('saveMarkersBtn');
function updateSaveButtonVisibility() {
  saveMarkersBtn.style.display = editMode ? '' : 'none';
}
updateSaveButtonVisibility();
editModeToggleBtn.textContent = editMode ? 'Switch to read-only' : 'Switch to edit-mode';
editModeToggleBtn.addEventListener('click', function() {
  editMode = !editMode;
  localStorage.setItem('editMode', editMode);
  editModeToggleBtn.textContent = editMode ? 'Switch to read-only' : 'Switch to edit-mode';
  updateSaveButtonVisibility();
  // Herlaad de pagina zodat alle UI en popups correct zijn
  location.reload();
});

var markersList = [];
var nextMarkerId = 1;

// Markers inladen bij openen pagina
fetch('markers.json')
  .then(res => res.json())
  .then(data => {
    data.forEach(function(m) {
      var width = 6, height = 6, angle = typeof m.angle === 'number' ? m.angle : 0;
      var center = L.latLng(m.lat, m.lng);
      var corners = getRectangleCornersMeters(center, width, height, angle);
      var rect = L.polygon(corners, {color: "blue", weight: 2});
      var handle = L.marker(corners[2], {
        draggable: true,
        icon: L.divIcon({
          className: 'rotate-handle',
          iconSize: [8, 8],
          html: `<div style=\"width:8px;height:8px;border-radius:50%;background:#3388ff;\"></div>`
        })
      });
      var marker = L.marker(center, {draggable: true}).addTo(map);
      // Rechthoek en handle altijd zichtbaar, ongeacht editMode
      rect.addTo(map);
      handle.addTo(map);
      var markerObj = {
        id: m.id,
        marker: marker,
        rect: rect,
        handle: handle,
        name: m.name || "",
        img: m.img || "",
        standnr: m.standnr || "",
        websitelink: m.websitelink || "",
        width: width,
        height: height,
        angle: angle
      };
      marker.bindPopup(createEditablePopup(markerObj));

      marker.on('popupopen', function(ev) {
        var id = markerObj.id;
        if (editMode && document.getElementById(`save_${id}`)) {
          document.getElementById(`save_${id}`).onclick = function() {
            markerObj.name = document.getElementById(`name_${id}`).value;
            markerObj.img = document.getElementById(`img_${id}`).value;
            markerObj.standnr = document.getElementById(`standnr_${id}`).value;
            markerObj.websitelink = document.getElementById(`web_${id}`).value;
            // Direct opslaan na save-button click
            var data = markersList.map(function(obj) {
              return {
                id: obj.id,
                lat: obj.marker.getLatLng().lat,
                lng: obj.marker.getLatLng().lng,
                name: obj.name,
                img: obj.img,
                standnr: obj.standnr,
                websitelink: obj.websitelink,
                angle: obj.angle || 0
              };
            });
            fetch('/save-markers', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            });
            marker.closePopup();
          };
        }
      });

      marker.on('drag', function(e) {
        if (!editMode) return;
        var center = e.latlng;
        markerObj.rect.setLatLngs(getRectangleCornersMeters(center, markerObj.width, markerObj.height, markerObj.angle));
        markerObj.handle.setLatLng(getRectangleCornersMeters(center, markerObj.width, markerObj.height, markerObj.angle)[2]);
      });
      marker.on('dragend', function(ev) {
        marker.setPopupContent(createEditablePopup(markerObj));
        if (editMode) {
          var data = markersList.map(function(obj) {
            return {
              id: obj.id,
              lat: obj.marker.getLatLng().lat,
              lng: obj.marker.getLatLng().lng,
              name: obj.name,
              img: obj.img,
              standnr: obj.standnr,
              websitelink: obj.websitelink,
              angle: obj.angle || 0
            };
          });
          fetch('/save-markers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }
      });

      handle.on('drag', function(e) {
        if (!editMode) return;
        var center = marker.getLatLng();
        var handleLatLng = e.latlng;
        var dx = (handleLatLng.lng - center.lng) * Math.cos(center.lat * Math.PI / 180) * 6378137 * Math.PI / 180;
        var dy = (handleLatLng.lat - center.lat) * 6378137 * Math.PI / 180;
        var newAngle = Math.atan2(dy, dx) * 180 / Math.PI - 45;
        markerObj.angle = newAngle;
        markerObj.rect.setLatLngs(getRectangleCornersMeters(center, markerObj.width, markerObj.height, markerObj.angle));
        markerObj.handle.setLatLng(getRectangleCornersMeters(center, markerObj.width, markerObj.height, markerObj.angle)[2]);
      });
      handle.on('dragend', function(e) {
        marker.setPopupContent(createEditablePopup(markerObj));
        if (editMode) {
          var data = markersList.map(function(obj) {
            return {
              id: obj.id,
              lat: obj.marker.getLatLng().lat,
              lng: obj.marker.getLatLng().lng,
              name: obj.name,
              img: obj.img,
              standnr: obj.standnr,
              websitelink: obj.websitelink,
              angle: obj.angle || 0
            };
          });
          fetch('/save-markers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }
      });

      marker.on('contextmenu', function(ev) {
  if (!editMode) return;
  map.removeLayer(marker);
  map.removeLayer(rect);
  map.removeLayer(handle);
  markersList = markersList.filter(function(obj) { return obj.id !== markerObj.id; });
      });

      marker.dragging[editMode ? 'enable' : 'disable']();
      handle.dragging[editMode ? 'enable' : 'disable']();
      markersList.push(markerObj);
      if (markerObj.id >= nextMarkerId) nextMarkerId = markerObj.id + 1;
    });
  });

function createEditablePopup(markerObj) {
  var lat = markerObj.marker.getLatLng().lat.toFixed(8);
  var lng = markerObj.marker.getLatLng().lng.toFixed(8);
  var id = markerObj.id;
  var name = markerObj.name || "";
  var img = markerObj.img || "";
  var standnr = markerObj.standnr || "";
  var websitelink = markerObj.websitelink || "";
  var disabled = editMode ? "" : "disabled";
  var saveBtn = editMode ? `<button id="save_${id}" style="margin-top:6px">Opslaan</button>` : "";
  var idLatLngBlock = editMode ?
    `<div><b>ID:</b> <span>${id}</span></div>
     <div><b>Lat:</b> <span>${lat}</span></div>
     <div><b>Lng:</b> <span>${lng}</span></div>`
    : "";
  return `
    <div style="min-width:220px">
      ${idLatLngBlock}
      <div><b>Naam:</b> <input type="text" id="name_${id}" value="${name}" style="width:140px" ${disabled}/></div>
      <div><b>Afbeelding:</b> <input type="text" id="img_${id}" value="${img}" style="width:140px" placeholder="URL" ${disabled}/></div>
      <div><b>Standnr:</b> <input type="number" id="standnr_${id}" value="${standnr}" style="width:60px" ${disabled}/></div>
      <div><b>Website:</b> <input type="text" id="web_${id}" value="${websitelink}" style="width:140px" placeholder="https://..." ${disabled}/></div>
      ${saveBtn}
    </div>
  `;
}

map.on('click', function(e) {
  if (!editMode) return;
  var width = 6, height = 6, angle = 0;
  var center = e.latlng;
  var corners = getRectangleCornersMeters(center, width, height, angle);
  var rect = L.polygon(corners, {color: "blue", weight: 2}).addTo(map);
  var marker = L.marker(center, {draggable: true}).addTo(map);
  var handle = L.marker(corners[2], {
    draggable: true,
    icon: L.divIcon({
      className: 'rotate-handle',
      iconSize: [10, 10]
    })
  }).addTo(map);
  var markerId = nextMarkerId++;
  var markerObj = {
    id: markerId,
    marker: marker,
    rect: rect,
    handle: handle,
    name: "",
    img: "",
    standnr: "",
    websitelink: "",
    width: width,
    height: height,
    angle: angle
  };
  marker.bindPopup(createEditablePopup(markerObj));

  marker.on('popupopen', function(ev) {
    var id = markerObj.id;
    // Altijd popup hertekenen met actuele editMode status
    setTimeout(function() {
      marker.setPopupContent(createEditablePopup(markerObj));
      // Save-button alleen in edit mode
      if (editMode) {
        document.getElementById(`save_${id}`).onclick = function() {
          markerObj.name = document.getElementById(`name_${id}`).value;
          markerObj.img = document.getElementById(`img_${id}`).value;
          markerObj.standnr = document.getElementById(`standnr_${id}`).value;
          markerObj.websitelink = document.getElementById(`web_${id}`).value;
          // Herteken popup zodat disabled/save-knop direct klopt
          setTimeout(function() {
            marker.setPopupContent(createEditablePopup(markerObj));
            marker.openPopup();
          }, 0);
          // Direct opslaan na save-button click
          var data = markersList.map(function(obj) {
            return {
              id: obj.id,
              lat: obj.marker.getLatLng().lat,
              lng: obj.marker.getLatLng().lng,
              name: obj.name,
              img: obj.img,
              standnr: obj.standnr,
              websitelink: obj.websitelink,
              angle: obj.angle || 0
            };
          });
          fetch('/save-markers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        };
      }
    }, 0);
  });

  marker.on('drag', function(e) {
    var center = e.latlng;
    markerObj.rect.setLatLngs(getRectangleCornersMeters(center, markerObj.width, markerObj.height, markerObj.angle));
    markerObj.handle.setLatLng(getRectangleCornersMeters(center, markerObj.width, markerObj.height, markerObj.angle)[2]);
  });
  marker.on('dragend', function(ev) {
    marker.setPopupContent(createEditablePopup(markerObj));
  });

  handle.on('drag', function(e) {
    var center = marker.getLatLng();
    var handleLatLng = e.latlng;
    var dx = (handleLatLng.lng - center.lng) * Math.cos(center.lat * Math.PI / 180) * 6378137 * Math.PI / 180;
    var dy = (handleLatLng.lat - center.lat) * 6378137 * Math.PI / 180;
    var newAngle = Math.atan2(dy, dx) * 180 / Math.PI - 45;
    markerObj.angle = newAngle;
    markerObj.rect.setLatLngs(getRectangleCornersMeters(center, markerObj.width, markerObj.height, markerObj.angle));
    markerObj.handle.setLatLng(getRectangleCornersMeters(center, markerObj.width, markerObj.height, markerObj.angle)[2]);
  });
  handle.on('dragend', function(e) {
    marker.setPopupContent(createEditablePopup(markerObj));
  });

  marker.on('contextmenu', function(ev) {
    if (!editMode) return;
    map.removeLayer(marker);
    map.removeLayer(rect);
    map.removeLayer(handle);
    markersList = markersList.filter(function(obj) { return obj.id !== markerId; });
  });

  marker.dragging[editMode ? 'enable' : 'disable']();
  handle.dragging[editMode ? 'enable' : 'disable']();
  markersList.push(markerObj);
});
// Helper: meters <-> lat/lng
function metersToLatLng(centerLatLng, dx, dy) {
  var R = 6378137;
  var dLat = dy / R;
  var dLng = dx / (R * Math.cos(Math.PI * centerLatLng.lat / 180));
  return [
    centerLatLng.lat + dLat * 180 / Math.PI,
    centerLatLng.lng + dLng * 180 / Math.PI
  ];
}

function getRectangleCornersMeters(centerLatLng, width_m, height_m, angleDeg) {
  var hw = width_m / 2;
  var hh = height_m / 2;
  var angleRad = angleDeg * Math.PI / 180;
  var localCorners = [
    [-hw, -hh], // SW
    [ hw, -hh], // SE
    [ hw,  hh], // NE
    [-hw,  hh]  // NW
  ];
  return localCorners.map(function(p) {
    var x = p[0], y = p[1];
    var xr = x * Math.cos(angleRad) - y * Math.sin(angleRad);
    var yr = x * Math.sin(angleRad) + y * Math.cos(angleRad);
    return metersToLatLng(centerLatLng, xr, yr);
  });
}

// Opslaan knop functionaliteit
document.getElementById('saveMarkersBtn').onclick = function() {
  // markersList naar JSON, inclusief rotatiehoek
  var data = markersList.map(function(obj) {
    return {
      id: obj.id,
      lat: obj.marker.getLatLng().lat,
      lng: obj.marker.getLatLng().lng,
      name: obj.name,
      img: obj.img,
      standnr: obj.standnr,
      websitelink: obj.websitelink,
      angle: obj.angle || 0
    };
  });
  fetch('/save-markers', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
  .then(res => res.json())
  .then(result => {
    document.getElementById('saveStatus').textContent = result.status === 'saved' ? 'Opgeslagen!' : 'Fout bij opslaan';
    setTimeout(function() { document.getElementById('saveStatus').textContent = ''; }, 2000);
  })
  .catch(err => {
    document.getElementById('saveStatus').textContent = 'Fout bij opslaan';
    setTimeout(function() { document.getElementById('saveStatus').textContent = ''; }, 2000);
  });
};
</script>
</script>
</body>
</html>
