<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Leaflet Map Marker Editor</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    #map { height: 100vh; width: 100vw; }
    .mode-toggle { position: fixed; top: 10px; left: 10px; z-index: 1000; }
  </style>
</head>
<body>
<button class="mode-toggle">Switch to Edit Mode</button>
<div id="map"></div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let editMode = false;
const modeToggle = document.querySelector('.mode-toggle');
const map = L.map('map', {
  minZoom: 16,
  maxZoom: 22
}).setView([51.898819375615844, 5.7732504428013165], 18);

L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
  subdomains: 'abcd',
  minZoom: 16,
  maxZoom: 22
}).addTo(map);

L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  attribution: 'Tiles &copy; Esri'
}).addTo(map);

let markerData = [];

// Load markers from backend
async function loadMarkers() {
  const res = await fetch('/markers.json');
  if (res.ok) {
    markerData = await res.json();
    addMarkersToMap();
  }
}

// Add markers/rects from markerData
function addMarkersToMap() {
  markerData.forEach(data => {
    if (data.type === 'marker') {
      const marker = L.marker([data.lat, data.lng], { draggable: false })
        .addTo(map)
        .bindPopup(data.popup || '');
    }
    // Rectangle example (add more as needed)
    if (data.type === 'rectangle') {
      const bounds = [
        [data.center[0] - data.height/111000/2, data.center[1] - data.width/111000/2],
        [data.center[0] + data.height/111000/2, data.center[1] + data.width/111000/2]
      ];
      L.rectangle(bounds, { color: "blue", weight: 2 })
        .addTo(map)
        .bindPopup(data.popup || '');
    }
  });
}

// Add marker on click (edit mode only)
map.on('click', function(e) {
  if (!editMode) return;
  const marker = L.marker(e.latlng, { draggable: true }).addTo(map);
  marker.bindPopup('<textarea placeholder="Enter info"></textarea><br><button class="save-popup">Save</button>').openPopup();
  marker.on('popupopen', function() {
    document.querySelector('.save-popup').onclick = function() {
      const popup = marker.getPopup();
      const info = document.querySelector('textarea').value;
      popup.setContent(info);
      markerData.push({ type: 'marker', lat: marker.getLatLng().lat, lng: marker.getLatLng().lng, popup: info });
      marker.closePopup();
      autoSaveMarkers();
    };
  });
  marker.on('dragend', function() {
    // Update position in markerData
    let m = markerData.find(m => m.lat === marker.getLatLng().lat && m.lng === marker.getLatLng().lng);
    if (m) {
      m.lat = marker.getLatLng().lat;
      m.lng = marker.getLatLng().lng;
      autoSaveMarkers();
    }
  });
});

// Toggle mode
modeToggle.onclick = function() {
  editMode = !editMode;
  modeToggle.textContent = editMode ? "Switch to Read-Only Mode" : "Switch to Edit Mode";
};

function autoSaveMarkers() {
  fetch('/save-markers', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(markerData)
  });
}

// Initial load
loadMarkers();
</script>
</body>
</html>
