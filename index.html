<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    #map { height: 100vh; width: 100vw; }
    .rotate-handle {
      background: #3388ff; /* Leaflet blue */
      border-radius: 50%;
      width: 10px;
      height: 10px;
      box-shadow: 0 0 2px #222;
      /* No border! */
    }
  </style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
var map = L.map('map', {
  minZoom: 16,
  maxZoom: 22
}).setView([51.898819375615844, 5.7732504428013165], 18);

 var terrainMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
	attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
	subdomains: 'abcd',
	minZoom: 16,
  maxZoom: 22
});
terrainMap.addTo(map); 
var esri_WorldImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
	attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
});
	esri_WorldImagery.addTo(map);
	
// Utility: meters <-> lat/lng
function metersToLatLng(centerLatLng, dx, dy) {
  var R = 6378137;
  var dLat = dy / R;
  var dLng = dx / (R * Math.cos(Math.PI * centerLatLng.lat / 180));
  return [
    centerLatLng.lat + dLat * 180 / Math.PI,
    centerLatLng.lng + dLng * 180 / Math.PI
  ];
}

function getRectangleCornersMeters(centerLatLng, width_m, height_m, angleDeg) {
  var hw = width_m / 2;
  var hh = height_m / 2;
  var angleRad = angleDeg * Math.PI / 180;
  var localCorners = [
    [-hw, -hh], // SW
    [ hw, -hh], // SE
    [ hw,  hh], // NE
    [-hw,  hh]  // NW
  ];
  return localCorners.map(function(p) {
    var x = p[0], y = p[1];
    var xr = x * Math.cos(angleRad) - y * Math.sin(angleRad);
    var yr = x * Math.sin(angleRad) + y * Math.cos(angleRad);
    return metersToLatLng(centerLatLng, xr, yr);
  });
}

// Initial rectangle properties
var center = L.latLng(51.898819375615844, 5.7732504428013165);
var width = 6;    // meters
var height = 6;   // meters
var angle = 0;    // degrees

var corners = getRectangleCornersMeters(center, width, height, angle);
var rect = L.polygon(corners, {color: "blue", weight: 2}).addTo(map);

// Center marker (built-in Leaflet marker)
var centerMarker = L.marker(center, {
  draggable: true
}).addTo(map);

// Rotation handle (NE corner, custom blue dot NO border)
var handleMarker = L.marker(corners[2], {
  draggable: true,
  icon: L.divIcon({
    className: 'rotate-handle',
    iconSize: [10, 10]
  })
}).addTo(map);

// Helper function: show popup with coords and angle
function showMarkerPopup(latlng, angle) {
  var lat = latlng.lat.toFixed(8);
  var lng = latlng.lng.toFixed(8);
  var angleText = angle.toFixed(2);
  centerMarker.bindPopup(
    "Lat: " + lat + "<br>Lng: " + lng + "<br>Angle: " + angleText + "Â°"
  ).openPopup();
}

// Drag center marker to move rectangle and handle
centerMarker.on('drag', function(e) {
  center = e.latlng;
  corners = getRectangleCornersMeters(center, width, height, angle);
  rect.setLatLngs(corners);
  handleMarker.setLatLng(corners[2]);
});

// Drag rotation handle to rotate rectangle
handleMarker.on('drag', function(e) {
  var handleLatLng = e.latlng;
  var dx = (handleLatLng.lng - center.lng) * Math.cos(center.lat * Math.PI / 180) * 6378137 * Math.PI / 180;
  var dy = (handleLatLng.lat - center.lat) * 6378137 * Math.PI / 180;
  var newAngle = Math.atan2(dy, dx) * 180 / Math.PI - 45;
  angle = newAngle;
  corners = getRectangleCornersMeters(center, width, height, angle);
  rect.setLatLngs(corners);
  handleMarker.setLatLng(corners[2]);
});

// Show popup with coordinates + angle when the marker is clicked
centerMarker.on('click', function(e) {
  showMarkerPopup(e.latlng, angle);
});

// Show popup when dragging ends
centerMarker.on('dragend', function(e) {
  showMarkerPopup(e.target.getLatLng(), angle);
  handleMarker.setLatLng(getRectangleCornersMeters(center, width, height, angle)[2]);
});
handleMarker.on('dragend', function() {
  handleMarker.setLatLng(getRectangleCornersMeters(center, width, height, angle)[2]);
  showMarkerPopup(center, angle);
});
</script>
</body>
</html>
