<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    #map { height: 100vh; width: 100vw; }
  </style>
</head>
<body>

  <div id="editModeToggle">
    <label for="editModeCheckbox" style="cursor:pointer;font-weight:bold;">Edit Mode</label>
    <input type="checkbox" id="editModeCheckbox" />
    <button id="saveMarkersBtn" style="margin-left:16px;">Opslaan</button>
    <span id="saveStatus" style="margin-left:8px;color:green;"></span>
  </div>
  <div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
var map = L.map('map', {
  minZoom: 16,
  maxZoom: 22
}).setView([51.898819375615844, 5.7732504428013165], 18);

var terrainMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
  subdomains: 'abcd',
  minZoom: 16,
  maxZoom: 22
});
terrainMap.addTo(map);
var esri_WorldImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
});
esri_WorldImagery.addTo(map);


// --- Edit Mode Logic ---
var editMode = false;
var editCheckbox = document.getElementById('editModeCheckbox');
editCheckbox.addEventListener('change', function() {
  editMode = editCheckbox.checked;
  markersList.forEach(function(obj) {
    if(obj.marker) obj.marker.dragging[editMode ? 'enable' : 'disable']();
  });
});

var markersList = [];
var nextMarkerId = 1;

// Markers inladen bij openen pagina
fetch('markers.json')
  .then(res => res.json())
  .then(data => {
    data.forEach(function(m) {
      var markerObj = {
        id: m.id,
        marker: L.marker([m.lat, m.lng], {draggable: true}).addTo(map),
        name: m.name || "",
        img: m.img || "",
        standnr: m.standnr || "",
        websitelink: m.websitelink || ""
      };
      markerObj.marker.bindPopup(createEditablePopup(markerObj));

      markerObj.marker.on('popupopen', function(ev) {
        var id = markerObj.id;
        document.getElementById(`save_${id}`).onclick = function() {
          markerObj.name = document.getElementById(`name_${id}`).value;
          markerObj.img = document.getElementById(`img_${id}`).value;
          markerObj.standnr = document.getElementById(`standnr_${id}`).value;
          markerObj.websitelink = document.getElementById(`web_${id}`).value;
          markerObj.marker.setPopupContent(createEditablePopup(markerObj));
          markerObj.marker.openPopup();
        };
      });

      markerObj.marker.on('dragend', function(ev) {
        markerObj.marker.setPopupContent(createEditablePopup(markerObj));
      });

      markerObj.marker.on('contextmenu', function(ev) {
        if (!editMode) return;
        map.removeLayer(markerObj.marker);
        markersList = markersList.filter(function(obj) { return obj.id !== markerObj.id; });
      });

      markerObj.marker.dragging[editMode ? 'enable' : 'disable']();
      markersList.push(markerObj);
      // Zorg dat nextMarkerId altijd hoger is dan bestaande
      if (markerObj.id >= nextMarkerId) nextMarkerId = markerObj.id + 1;
    });
  });

function createEditablePopup(markerObj) {
  var lat = markerObj.marker.getLatLng().lat.toFixed(8);
  var lng = markerObj.marker.getLatLng().lng.toFixed(8);
  var id = markerObj.id;
  var name = markerObj.name || "";
  var img = markerObj.img || "";
  var standnr = markerObj.standnr || "";
  var websitelink = markerObj.websitelink || "";
  // id en coords niet bewerkbaar, rest wel
  return `
    <div style="min-width:220px">
      <div><b>ID:</b> <span>${id}</span></div>
      <div><b>Lat:</b> <span>${lat}</span></div>
      <div><b>Lng:</b> <span>${lng}</span></div>
      <div><b>Naam:</b> <input type="text" id="name_${id}" value="${name}" style="width:140px"/></div>
      <div><b>Afbeelding:</b> <input type="text" id="img_${id}" value="${img}" style="width:140px" placeholder="URL"/></div>
      <div><b>Standnr:</b> <input type="number" id="standnr_${id}" value="${standnr}" style="width:60px"/></div>
      <div><b>Website:</b> <input type="text" id="web_${id}" value="${websitelink}" style="width:140px" placeholder="https://..."/></div>
      <button id="save_${id}" style="margin-top:6px">Opslaan</button>
    </div>
  `;
}

map.on('click', function(e) {
  if (!editMode) return;
  var markerId = nextMarkerId++;
  var markerObj = {
    id: markerId,
    marker: L.marker(e.latlng, {draggable: true}).addTo(map),
    name: "",
    img: "",
    standnr: "",
    websitelink: ""
  };
  markerObj.marker.bindPopup(createEditablePopup(markerObj));

  markerObj.marker.on('popupopen', function(ev) {
    // id, lat, lng niet bewerkbaar
    var id = markerObj.id;
    document.getElementById(`save_${id}`).onclick = function() {
      markerObj.name = document.getElementById(`name_${id}`).value;
      markerObj.img = document.getElementById(`img_${id}`).value;
      markerObj.standnr = document.getElementById(`standnr_${id}`).value;
      markerObj.websitelink = document.getElementById(`web_${id}`).value;
      markerObj.marker.setPopupContent(createEditablePopup(markerObj));
      markerObj.marker.openPopup();
    };
  });

  markerObj.marker.on('dragend', function(ev) {
    // Update popup met nieuwe coords
    markerObj.marker.setPopupContent(createEditablePopup(markerObj));
  });

  // Verwijder marker bij rechtermuisklik in edit-modus
  markerObj.marker.on('contextmenu', function(ev) {
    if (!editMode) return;
    map.removeLayer(markerObj.marker);
    markersList = markersList.filter(function(obj) { return obj.id !== markerId; });
  });

  // Zet drag state bij aanmaken
  markerObj.marker.dragging[editMode ? 'enable' : 'disable']();

  markersList.push(markerObj);
});

// Opslaan knop functionaliteit
document.getElementById('saveMarkersBtn').onclick = function() {
  // markersList naar JSON, alleen relevante data
  var data = markersList.map(function(obj) {
    return {
      id: obj.id,
      lat: obj.marker.getLatLng().lat,
      lng: obj.marker.getLatLng().lng,
      name: obj.name,
      img: obj.img,
      standnr: obj.standnr,
      websitelink: obj.websitelink
    };
  });
  fetch('/save-markers', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
  .then(res => res.json())
  .then(result => {
    document.getElementById('saveStatus').textContent = result.status === 'saved' ? 'Opgeslagen!' : 'Fout bij opslaan';
    setTimeout(function() { document.getElementById('saveStatus').textContent = ''; }, 2000);
  })
  .catch(err => {
    document.getElementById('saveStatus').textContent = 'Fout bij opslaan';
    setTimeout(function() { document.getElementById('saveStatus').textContent = ''; }, 2000);
  });
};
</script>
</script>
</body>
</html>
